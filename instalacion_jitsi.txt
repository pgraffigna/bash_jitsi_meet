########### instalacion jitsi meet #####################
# cambiando el hostname
sudo hostnamectl set-hostname jitsi.cultura.lab
sudo sed -i 's/127\.0\.1\.1[\t]ubuntu2004\.localdomain/127\.0\.1\.1       jitsi\.cultura\.lab/' /etc/hosts

# llaves prosody
wget -q https://prosody.im/files/prosody-debian-packages.key -O- | sudo apt-key add -

# agregando repo prosody
echo deb http://packages.prosody.im/debian $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list

# llaves jitsi
curl -s https://download.jitsi.org/jitsi-key.gpg.key | sudo sh -c 'gpg --dearmor > /usr/share/keyrings/jitsi-keyring.gpg'

# agregando repo jitsi
echo 'deb [signed-by=/usr/share/keyrings/jitsi-keyring.gpg] https://download.jitsi.org stable/' | sudo tee /etc/apt/sources.list.d/jitsi-stable.list > /dev/null

# actualizando repos + instalando jitsi - prosody + certificados auto-firmados
sudo apt update; sudo apt install jitsi-meet -y 

############### autenticacion ###################
# configurando autenticacion 
editar /etc/prosody/conf.avail/jitsi.cultura.lab.cfg.lua
--> authentication = "jitsi-anonymous" --  authentication = "internal_plain" 

--> agregar al final del archivo
VirtualHost "guest.jitsi.cultura.lab"
    authentication = "anonymous"
    c2s_require_encryption = false

# configurar dominio anonimo
editar /etc/jitsi/meet/jitsi.cultura.lab-config.js
--> // anonymousdomain: 'guest.example.com', anonymousdomain: 'guest.jitsi.cultura.lab'

# configurar jicofo
editar /etc/jitsi/jicofo/sip-communicator.properties
--> org.jitsi.jicofo.auth.URL=XMPP:jitsi.cultura.lab

# crear usuario local
sudo prosodyctl register pgraffigna jitsi.cultura.lab password1234

# reiniciar servicios
sudo systemctl restart prosody.service jicofo.service jitsi-videobridge2.service

######### ldap ########################################
# instalacion dependencias
sudo apt-get install -y sasl2-bin libsasl2-modules-ldap lua-cyrussasl
sudo prosodyctl install --server=https://modules.prosody.im/rocks/ mod_auth_cyrus

# configuracion ldap
editar /etc/saslauthd.conf

ldap_servers: ldap://192.168.121.152
ldap_bind_dn: cn=admin,dc=cultura,dc=lab
ldap_bind_pw: eteZZisn
ldap_auth_method: bind
ldap_search_base: ou=USUARIOS,dc=cultura,dc=lab
ldap_filter: (&(uid=%u)(objectClass=*)(title=jitsi))
ldap_version: 3

# testear conexiÃ³n ldap
ventana1>sudo saslauthd -d -a ldap
ventana2>sudo testsaslauthd -u pgraffigna -p password123

# configurar saslauthd para que inicie en boot + que use ldap para validar
sudo sed -i -e "s/START=.*/START=yes/" -e "s/MECHANISMS=.*/MECHANISMS=\"ldap\"/" /etc/default/saslauthd

# reiniciar servicio
sudo service saslauthd restart

# Cyrus SASL Configuration file
sudo mkdir /etc/sasl

cat << 'EOF' |sudo tee /etc/sasl/prosody.conf > /dev/null
pwcheck_method: saslauthd
mech_list: PLAIN
EOF

# configurar prosody
sudo sed -i -E -e "/^ *VirtualHost \"$(hostname -f)\"/,/^ *VirtualHost/ {s/authentication ?=.*$/authentication = \"cyrus\"/}" /etc/prosody/conf.avail/$(hostname -f).cfg.lua

# permisos 
sudo adduser prosody sasl

# reinicio de servicios
sudo service prosody restart

################ usuarios locales ############3333
# creacion usuarios locales
sudo prosodyctl register testing jitsi.cultura.lab password1234

# validando usuario
cat /var/lib/prosody/jitsi%2ecultura%2elab/accounts/pgraffigna.dat

